<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>瀑布流</title>
	<style>
		*{
			padding: 0;
			margin: 0;
			border: 0;
		}
		body,html{
			width: 100%;
			height: 100%;
		}
		#main{
			position: relative;
			background: #f00;
		}
		.box{
			padding: 15px 0 0 15px;
			float: left;
		}
		.pic{
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 5px;
			background: #fff;
		}
		.box #pic img{
			vertical-align: top;
		}
	</style>
</head>
<body>
	<div id="main">
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/1.jpg" style="width: 180px;height: 200px;"></div>
		</div>
		<div class="box">
			<div class="pic"><img src="../img/2.jpg" style="width: 180px;height: 150px;"></div>
		</div>
	</div>

	<script>
		var main = $('main');
		var box = main.getElementsByClassName('box');

		waterFull(main,box);

		function waterFull(parentBox,childBox){
			const boxWidth = childBox[0].offsetWidth;

			var screenWidth = document.documentElement.clientWidth ||
			 document.body.clientWidth;
			const cols = Math.floor(screenWidth / boxWidth);
			
			parentBox.style.width = cols * boxWidth + 15 + 'px';
			parentBox.style.margin = '0 auto';

			const heightArr = [];
			let minBoxHeight = 0, minBoxIndex = 0;

			for(var i = 0; i < childBox.length; i++){
				var iChildBox = childBox[i];
				if(i < cols){
					heightArr.push(iChildBox.offsetHeight);
					iChildBox.style = '';
				}
				else{
					minBoxHeight = Math.min.apply(null,heightArr);
					minBoxIndex = heightArr.indexOf(minBoxHeight);

					iChildBox.style.position = 'absolute';
					iChildBox.style.left = minBoxIndex * iChildBox.offsetWidth + 'px';
					iChildBox.style.top = minBoxHeight + 'px';

					heightArr[minBoxIndex] += iChildBox.offsetHeight;
				}
			}
		}

		window.onresize = function(){
			//节流  页面性能优化
			var timeout = null;
			clearTimeout(timeout);

			timeout = setTimeout(function(){
				waterFull(main,box);
			},200);
		}

		window.onscroll = function(){
			var timeout = null;
			clearTimeout(timeout);

			timeout = setTimeout(function(){
				const lastBox = box[box.length - 1];
				const lastBoxHalfHeight = lastBox.offsetHeight * .5;
				const lastBoxDis = lastBoxHalfHeight + lastBox.offsetTop;
				const clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
				const scrollDis = window.pageYOffset + clientHeight;

				if(lastBoxDis <= scrollDis){
					// alert(1)
				var data = [
					{src:'../img/01.jpg',width:180,height:200},
					{src:'../img/02.jpg',width:180,height:180},
					{src:'../img/03.jpg',width:180,height:170},
					{src:'../img/04.jpg',width:180,height:175},
					{src:'../img/05.jpg',width:180,height:190},
					{src:'../img/06.jpg',width:180,height:180},
					{src:'../img/07.jpg',width:180,height:170},
					{src:'../img/08.jpg',width:180,height:175},
					{src:'../img/09.jpg',width:180,height:185},
				];

				for(var i = 0; i < data.length; i++){
					var newBox = document.createElement('div');
					newBox.className = 'box';
					main.appendChild(newBox);

					var newPic = document.createElement('div');
					newPic.className = 'pic';
					newBox.appendChild(newPic);

					var newImg = document.createElement('img');
					newImg.src = data[i].src;
					newImg.width = data[i].width;
					newImg.height = data[i].height;
					newPic.appendChild(newImg);
				}

					waterFull(main,box);
				}
			},200);
		}

		function $(id){
			return typeof id === 'string' ? document.all(id) : null;
		}
	</script>
</body>
</html>